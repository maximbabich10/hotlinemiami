# 🤖 CIAN Telegram Bot - Автоматическая рассылка сообщений

> **✅ ОБНОВЛЕНО v2.0:** Добавлена система авторизации пользователей!
> 
> Теперь каждый риелтор регистрируется со своим номером телефона и работает под своим аккаунтом CIAN.

---

## 🚀 Быстрый старт

### 1. Установка Node.js 18+
- Скачайте с [nodejs.org](https://nodejs.org/)
- macOS: `brew install node`

### 2. Установка зависимостей
```bash
npm install
```

### 3. Создание Telegram бота
1. Найдите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте `/newbot` и следуйте инструкциям
3. Сохраните токен бота

### 4. Настройка `.env`
Скопируйте `env.example` в `.env`:
```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather

# Остальные настройки
MAX_PAGES=5
MAX_PER_PAGE=10
MIN_PAUSE=3
MAX_PAUSE=5
```

**ВАЖНО:** `CIAN_PHONE` больше не нужен в `.env`! Каждый пользователь регистрируется через бота.

### 5. Запуск
```bash
npm run dev
# или
npm start
```

### 6. Регистрация и использование
1. Откройте бота в Telegram
2. Отправьте `/start`
3. Отправьте `/register`
4. Введите ваш номер телефона (10 цифр без +7): `9771234567`
5. Нажмите **"▶️ Запустить рассылку"**
6. Введите код из SMS

---

## ✨ Возможности

- ✅ **Управление через Telegram** - запуск рассылки по кнопке
- ✅ **Многопользовательский режим** - каждый риелтор работает под своим аккаунтом
- ✅ **Система авторизации** - регистрация через Telegram бота
- ✅ **База данных SQLite** - хранение пользователей и статистики
- ✅ **Автоматическая авторизация** на CIAN по номеру телефона
- ✅ **Применение фильтров**: "От собственника" + "Без долей"
- ✅ **Варианты текста** - случайный выбор для уникальности
- ✅ **Без дублей** - сохраняет ID обработанных объявлений
- ✅ **Защита от капчи** - медленная скорость, случайные паузы
- ✅ **Мониторинг в реальном времени** - отчеты в Telegram
- ✅ **Антидетект браузер** - Puppeteer Stealth

---

## 📋 Команды Telegram бота

### Основные команды
- `/start` - Начало работы с ботом
- `/register` - Регистрация нового пользователя
- `/profile` - Просмотр профиля и статистики
- `/update` - Обновление номера телефона
- `/cancel` - Отмена текущей операции

### Кнопки
- **▶️ Запустить рассылку** - Начать работу
- **⏹️ Остановить рассылку** - Остановить бота
- **📊 Статистика** - Ваша статистика (сессии, объявления)
- **👤 Профиль** - Ваши данные и настройки
- **ℹ️ Помощь** - Справка

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────┐
│         Telegram Bot                    │
│  (telegram-bot.js)                      │
│  - Обработка команд                     │
│  - Управление пользователями            │
│  - Запуск рассылки                      │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│         Database Module                 │
│  (database.js)                          │
│  - SQLite база данных                   │
│  - Таблица users (пользователи)         │
│  - Таблица sessions (сессии)            │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│         CIAN Mailer                     │
│  (cian-mailer.js)                       │
│  - Puppeteer автоматизация              │
│  - Авторизация на CIAN                  │
│  - Обработка объявлений                 │
└─────────────────────────────────────────┘
```

Подробнее: [AUTH_GUIDE.md](./AUTH_GUIDE.md)

---

## 📁 Структура проекта

```
telegram-bot.js      # Главный файл - Telegram бот с системой авторизации
cian-mailer.js       # Автоматизация CIAN (Puppeteer)
database.js          # Модуль работы с БД (SQLite)
test-cian.js         # Тестовый скрипт
package.json         # Зависимости Node.js
env.example          # Пример конфигурации
users.db             # База данных пользователей (создается автоматически)
processed_ads.txt    # База обработанных объявлений (создается автоматически)

# Документация
README.md            # Главная документация
AUTH_GUIDE.md        # Руководство по авторизации
README_RU.md         # Полная документация на русском
QUICKSTART_RU.md     # Быстрый старт
INSTALL_RU.md        # Детальная установка
TELEGRAM_SETUP_RU.md # Настройка Telegram бота
LOGS_INFO.md         # Информация о логах
```

---

## ⚙️ Настройки

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `MAX_PAGES` | Количество страниц | 5 |
| `MAX_PER_PAGE` | Объявлений на странице | 10 |
| `MIN_PAUSE` | Мин. пауза между объявлениями (сек) | 15 |
| `MAX_PAUSE` | Макс. пауза между объявлениями (сек) | 25 |

**Скорость:** ~140 сообщений/час (защита от капчи)

---

## ⚠️ Важно

- ❗ Бот **НЕ отправляет** сообщения - только **вводит текст**
- ❗ Можно останавливать/запускать - продолжит с места остановки
- ❗ При капче - пропускает объявление и продолжает
- ❗ Все ID сохраняются в `processed_ads.txt`

---

## 🐛 Решение проблем

### Бот не запускается
```bash
rm -rf node_modules package-lock.json
npm install
```

### Ошибка авторизации CIAN
- Проверьте email/пароль в `.env`
- Попробуйте войти вручную на cian.ru

### Бот не отвечает в Telegram
- Проверьте `TELEGRAM_BOT_TOKEN` в `.env`
- Проверьте `TELEGRAM_ADMIN_ID` (получите через [@userinfobot](https://t.me/userinfobot))

---

## 📖 Полная документация

- **[README_RU.md](./README_RU.md)** - Подробная документация на русском
- **[INSTALL_RU.md](./INSTALL_RU.md)** - Пошаговая инструкция по установке

---

## 🔄 Миграция с Python

Если использовали старую Python версию:
1. ✅ Файл `processed_ads.txt` совместим - все обработанные объявления сохранятся
2. ✅ Настройки из `config.env` работают напрямую (или скопируйте в `.env`)
3. ✅ Старые Python файлы уже удалены

---

## 📝 Лицензия

MIT

---

## 📜 Эпиграф

> *Движенья нет, сказал мудрец брадатый.*  
> *Другой смолчал и стал пред ним ходить.*  
> *Сильнее бы не мог он возразить;*  
> *Хвалили все ответ замысловатый.*  
> 
> — А.С. Пушкин, "Движение" (1825)

---

**Удачной рассылки! 🚀**
